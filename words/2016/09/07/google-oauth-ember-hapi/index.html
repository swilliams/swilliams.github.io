
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Google OAuth, Ember, Hapi - Scott Williams</title>
	<meta name="author" content="Scott Williams">

	
	<meta name="description" content="Google OAuth, Ember, Hapi Sep 7th, 2016 OAuth is, to borrow a phrase, a bag of hurt. Not just any bag, but the kind that is thrown over your head &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Scott Williams" type="application/atom+xml">
	
	<link rel="canonical" href="http://blog.swilliams.me/words/2016/09/07/google-oauth-ember-hapi/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bigfoot-default.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<script type="text/javascript" src="/javascripts/bigfoot.min.js"></script>
<script type="text/javascript" src="//use.typekit.net/non4byl.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
<script type="text/javascript">
    $.bigfoot();
</script>

  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-57339923-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<img src="http://www.gravatar.com/avatar/c314e8a5296aeb512e30f0a11e357f7b?s=100" alt="Profile Picture" style="width: 100px;" />
	
</div>
<hgroup>
  <h1><a href="/">Scott Williams</a></h1>
  
    <h2>Code. Photos. Writing.</h2>
  
</hgroup>

<nav id="marketing">
    <p class="podcasts sidebar-stuff">I also make a podcast. Listen!</p>
    <ul class="podcasts sidebar-stuff">
      <li>
      <a href="https://itunes" class="app-icon"><img src="/images/assets/f2b-art-icon.png" /></a>
      <a href="http://fronttoback.co">Front to Back</a> &mdash; A show about fathers raising daughters
      </li>
    </ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		
			<a class="twitter" href="http://twitter.com/swilliams" title="Twitter"></a>
		
		
		
		
		
		
		
		
		
		
			<a class="rss" href="/atom.xml" title="RSS"></a>
		
	</div>
</nav>
<nav id="main-nav"><ul class="main-navigation">
</ul>

</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Google OAuth, Ember, Hapi</h1>
    <div class="date">








  


<time datetime="2016-09-07T08:10:50-07:00" data-updated="true" itemprop="datePublished">Sep 7<span>th</span>, 2016</time></div>
	<div class="entry-content" itemprop="articleBody"><p>OAuth is, to borrow a phrase, a bag of hurt. Not just any bag, but the kind that is thrown over your head right before you&rsquo;re thrown into a van and driven down to Tijuana and ransomed for $50,000. I don&rsquo;t like OAuth.</p>

<p>Sometimes, though you need to use it. I&rsquo;m working on an internal tool at <a href="http://tallwave.com">work</a> and want to make sure that only co-workers can use it. I could do the username/password thing, but the world has enough of those. We use Google docs for the office, so everyone has a Google account that could, theoretically, be used to sign in. Thus, OAuth.</p>

<p>The tool itself is a web app that uses <a href="http://emberjs.com/">Ember</a> on the front-end and <a href="http://hapijs.com/">Hapi</a> and <a href="https://www.mongodb.com/">MongoDB</a> as the API and database. It&rsquo;s my first time using Hapi, and I like it quite a bit, seems like a really good tool for API building.</p>

<p>Since this is a completely separate client and server, it adds a bit of a wrinkle to the OAuth dance. There are plenty of &ldquo;Sign in with X&rdquo; libraries out there, but they mostly seem to be written with the intent that the user will only be interacting with that service. In other words, if I was building a Google Docs client app, my life would be easier, but no, I am only authenticating a user&rsquo;s account and then treating that as the key to my own system&hellip; which makes it more manual. It also doesn&rsquo;t help that Google&rsquo;s OAuth documentation is lousy. There are many different ways to authenticate, and <a href="https://github.com/google/google-auth-library-nodejs">multiple</a> <a href="https://github.com/google/google-api-nodejs-client">libraries</a> to support the different ways, and they&rsquo;ve changed over time, so searching for help is difficult.</p>

<p>Here&rsquo;s how it&rsquo;s supposed to work:</p>

<ol>
<li>The client (Ember) &ldquo;signs in with Google&rdquo;. If this is successful it receives an <code>authorizationCode</code>. This code by itself is useless, it just means the user signed in ok.</li>
<li>The server (Hapi) needs to validate this code and turn it into an <code>accessToken</code>.</li>
<li>If <em>that</em> is successful, we can query the Google API (from the server still) for the account information, verify that they are from Tallwave, and then send credentials back down to the client.</li>
<li>The client receives the credentials, stores them locally, and includes them for subsequent API requests.</li>
</ol>


<p>Errors need to be handled at all the steps along the way too.</p>

<p><strong>Step 1 — Client Side</strong></p>

<p><a href="https://github.com/Vestorly/torii">Torii</a> is a pretty good (though a wee bit out of date) library for Ember that handles a good amount of the Google sign in process. Follow its installation instructions and setup the configuration and the proper adapter. Here&rsquo;s my <code>environment.js</code> entry:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="cm">/* The following properties are in ENV */</span>
</span><span class='line'><span class="nx">torii</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">sessionServiceName</span><span class="o">:</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">providers</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;google-oauth2&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">redirectUri</span><span class="o">:</span> <span class="nx">signinURL</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">apiKey</span><span class="o">:</span> <span class="nx">googleOAuthAPIKey</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">scope</span><span class="o">:</span> <span class="s1">&#39;profile email&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <a href="https://developers.google.com/+/web/api/rest/oauth#authorization-scopes"><code>scope</code></a> property is important. That allows you to query for the user&rsquo;s account later on. The only other point with Torii worth mentioning is how I sent the authorization code to my API. The <code>open</code> method on the <code>torii-adapters/application.js</code> is called after Google auth finishes, and that is where you create the &ldquo;session&rdquo; for authentication.</p>

<p>By default Ember uses the JSON API for the API layer, and I tend to go with the flow. But in this case, since we&rsquo;re sending a single value to the server and will throw it away immediately after&hellip; Setting up a model seems overkill for that. We can drop down to regular old jQuery for this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// This is in torii-adapters/application.js</span>
</span><span class='line'><span class="nx">open</span><span class="p">(</span><span class="nx">authentication</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">RSVP</span><span class="p">.</span><span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">authorizationCode</span><span class="o">:</span> <span class="nx">authentication</span><span class="p">.</span><span class="nx">authorizationCode</span> <span class="p">},</span>
</span><span class='line'>      <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">// this is the authentication URL in your API</span>
</span><span class='line'>      <span class="nx">success</span><span class="o">:</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">run</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">),</span> <span class="c1">// forward success/error to the Promise</span>
</span><span class='line'>      <span class="nx">error</span><span class="o">:</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">run</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">account</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;sessionStore&#39;</span><span class="p">).</span><span class="nx">save</span><span class="p">(</span><span class="nx">account</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span> <span class="nx">currentUser</span><span class="o">:</span> <span class="nx">account</span> <span class="p">};</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Worth pointing out is that we are expecting our API to return some JSON that will be:</p>

<ol>
<li>Stored locally (<code>sessionStore</code> is a <a href="https://guides.emberjs.com/v2.7.0/applications/services/">service</a>, which we&rsquo;ll define later), and will be retrieved later.</li>
<li>Returning the <code>currentUser</code> object will merge it into the underlying session, so that it can be retrieved in routes, components, templates etc. This isn&rsquo;t permanent storage though, if the user refreshes the page, it&rsquo;ll be gone, hence <code>sessionStore</code>.</li>
</ol>


<p><strong>Step 2 — On the Server</strong></p>

<p>This is where the fun begins. If you&rsquo;re playing at home, I used Node 5 and Hapi 13.x.x. First, you&rsquo;ll need to get your credentials from the <a href="https://console.developers.google.com">Google Developer Console</a>. I&rsquo;m not going to walk through those steps, but you&rsquo;ll need an OAuth client ID for a Web Application. Specifically, you&rsquo;ll need the client id, client secret, and redirect URL (yes, even though you won&rsquo;t be redirecting to anything at this point).</p>

<p>Then, install the <code>googleapis</code> dependency.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">googleapis</span> <span class="o">--</span><span class="nx">save</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s build a service that sends Google an <code>authorizationCode</code> and gets an accessToken back. You&rsquo;ll call this service from your route handler.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">Google</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;googleapis&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">OAuth2</span> <span class="o">=</span> <span class="nx">Google</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">OAuth2</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">profile</span> <span class="o">=</span> <span class="nx">Google</span><span class="p">.</span><span class="nx">oauth2</span><span class="p">(</span><span class="s1">&#39;v2&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// pull these from an ENV variable or something else</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">oauthClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OAuth2</span><span class="p">(</span><span class="nx">CLIENT_ID</span><span class="p">,</span> <span class="nx">CLIENT_SECRET</span><span class="p">,</span> <span class="nx">REDIRECT_URL</span><span class="p">);</span>
</span><span class='line'><span class="c1">// Omitting the REDIRECT_URL will throw an error</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// callback is a function whose signature is (error, tokens)</span>
</span><span class='line'>  <span class="nx">getTokens</span><span class="p">(</span><span class="nx">authorizationCode</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">oauthClient</span><span class="p">.</span><span class="nx">getToken</span><span class="p">(</span><span class="nx">authorizationCode</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// the authorization code was bad</span>
</span><span class='line'>        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="c1">// At this point, we have an access token.</span>
</span><span class='line'>      <span class="nx">oauthClient</span><span class="p">.</span><span class="nx">credentials</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Each Google API method takes a params object, </span>
</span><span class='line'>      <span class="c1">// which is where you provide your auth credentials</span>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">auth</span><span class="o">:</span> <span class="nx">oauthClient</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Retrieve the user&#39;s account</span>
</span><span class='line'>      <span class="nx">profile</span><span class="p">.</span><span class="nx">userinfo</span><span class="p">.</span><span class="nx">v2</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// The response object contains all of the account info</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// This is where you validate if the user is allowed or not.</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// If the user is valid, create a new session for them and save it.</span>
</span><span class='line'>        <span class="c1">// It&#39;s up to you where you want to save this session. Could be </span>
</span><span class='line'>        <span class="c1">// a redis cache, http session, whatever your needs are.</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// After that, we&#39;re going to send our session token and user </span>
</span><span class='line'>        <span class="c1">// account back.</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="kr">const</span> <span class="nx">sessionJSON</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">token</span><span class="o">:</span> <span class="nx">someSessionToken</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">account</span><span class="o">:</span> <span class="nx">response</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">newSession</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s kind of a mouthful and could definitely stand a good refactoring, but it goes through the steps needed to get some information from Google. You can see more <a href="http://google.github.io/google-api-nodejs-client/12.4.0/index.html">APIs</a> you can call, but the documentation on a lot of them is rather sparse. For example, adding the <code>oauthClient</code> to <code>params</code> is not apparent, but necessary for each call.</p>

<p>We&rsquo;ve now determined if the user should actually have access to what they just signed in to and sent the response back to the client. That&rsquo;s pretty good! Refresh your beverage, take a deep breath and then let&rsquo;s get handle that response and get our client in order to keep moving.</p>

<p><strong>Step 3 — Back on the Client</strong></p>

<p>You might have noticed again that we did not send the session information back in JSON API format either. This was intentional since we aren&rsquo;t going to be storing this in the standard Ember store, and therefore don&rsquo;t need the additional benefit of using something that standardized. You could if you wanted to, but for this occasion, I did not want to set up a model (or in this case model<em>s</em> to support the nested structure).</p>

<p>Back up in our <code>Ember.RSVP.Promise</code> handler there was this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// In torii-adapters/application.js</span>
</span><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;sessionStore&#39;</span><span class="p">).</span><span class="nx">save</span><span class="p">(</span><span class="nx">account</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once you receive a response, you&rsquo;ll need to store it. You could use Ember Data, but that felt overkill to me; I needed to access the tokens within the response for subsequent API calls, and nothing else. I ended up building an <a href="https://guides.emberjs.com/v2.8.0/applications/services/">Ember service</a> that serialized the content and stored it in <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage">localStorage</a>. You can go your own way too.</p>

<p><strong>Step 4 — Making authenticated requests</strong></p>

<p>We&rsquo;re authorized (or have displayed a fancy error message) and are ready to make actual requests to get actual data. I like to authenticate my API requests by including my authorization token in the <code>Authorization</code> header on requests. Ember allows for this by overriding the <code>headers</code> computed property in your Adapter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// adapters/application.js</span>
</span><span class='line'>  <span class="nx">headers</span><span class="o">:</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">computed</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;sessionStore&#39;</span><span class="p">).</span><span class="nx">fetch</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">account</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="nx">account</span><span class="p">.</span><span class="nx">_id</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{};</span>
</span><span class='line'>  <span class="p">}).</span><span class="kr">volatile</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Step 5 — Verify authentication on the server</strong></p>

<p>There are may ways to <a href="http://hapijs.com/tutorials/auth">authenticate requests with Hapi</a>. Hapi calls these &ldquo;Schemes&rdquo;. A Scheme is made up of multiple Strategies but since we only have one, we&rsquo;ll just refer to it as a Scheme.</p>

<p>You define a Scheme as a function that takes a <code>server</code> and some <code>options</code> as arguments and go from there. Here&rsquo;s <code>api-auth.js</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// These are the standard Hapi request/reply arguments</span>
</span><span class='line'>    <span class="nx">authenticate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Get the session token from the HTTP Headers of the request</span>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">raw</span><span class="p">.</span><span class="nx">req</span><span class="p">;</span>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">authorization</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">;</span>
</span><span class='line'>      <span class="c1">// Fail quickly if it isn&#39;t present.</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorization</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">reply</span><span class="p">(</span><span class="nx">Boom</span><span class="p">.</span><span class="nx">unauthorized</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;Basic&#39;</span><span class="p">));</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Pull the credentials from the session store that are </span>
</span><span class='line'>      <span class="c1">// associated with the session token. Fail if it&#39;s not valid.</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">tokenIsValid</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">reply</span><span class="p">(</span><span class="nx">Boom</span><span class="p">.</span><span class="nx">unauthorized</span><span class="p">(</span><span class="s1">&#39;Authenication failed&#39;</span><span class="p">,</span> <span class="s1">&#39;Basic&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Authenticated, so send the credentials along the chain in </span>
</span><span class='line'>      <span class="c1">// case they need to be used later.</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">reply</span><span class="p">.</span><span class="k">continue</span><span class="p">({</span> <span class="nx">credentials</span><span class="o">:</span> <span class="nx">credentials</span> <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we&rsquo;ve defined our Scheme, we need to register it with Hapi. Wherever the server is set up add this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Import our Scheme</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">apiScheme</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./config/api-scheme&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Auth</span>
</span><span class='line'>  <span class="c1">// Schemes have a name which you define here.</span>
</span><span class='line'>  <span class="nx">server</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">scheme</span><span class="p">(</span><span class="s1">&#39;auth-scheme&#39;</span><span class="p">,</span> <span class="nx">apiScheme</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Strategies also have a name. This is what you&#39;ll refer </span>
</span><span class='line'>  <span class="c1">// to when setting schemes for routes.</span>
</span><span class='line'>  <span class="nx">server</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">strategy</span><span class="p">(</span><span class="s1">&#39;basic-strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;auth-scheme&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// You can declare all routes to use a one Strategy by default.</span>
</span><span class='line'>  <span class="nx">server</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;basic-strategy&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Routes might go here</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you do use a default auth strategy, you can override that on individual routes in their handler config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">handler</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reply</span><span class="p">();</span> <span class="p">},</span>
</span><span class='line'>  <span class="nx">config</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">auth</span><span class="o">:</span> <span class="s1">&#39;another-strategy&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or use the boolean <code>false</code> to skip auth altogether for a route, such as your session creation API.</p>

<p>And we&rsquo;re done! You now have an authenticated API. There are plenty of other points that could be expanded on, but it&rsquo;s getting a little long in the tooth now.</p>

<p><strong>Wait, why not use Bell?</strong></p>

<p>The Hapi organization maintains a project called <a href="https://github.com/hapijs/bell">Bell</a> that is a &ldquo;Third-party login plugin for hapi&rdquo;, including OAuth services. It&rsquo;s great, but the catch is that since half of our authentication takes place in the browser, we can&rsquo;t quite use it the way it is intended to be used.</p>
</div>
    <div class="tags">Tags: 


	<a class='category' href='/words/categories/code/'>code,</a>, <a class='category' href='/words/categories/ember/'>ember,</a>, <a class='category' href='/words/categories/hapi/'>hapi</a>, <a class='category' href='/words/categories/oauth/'>oauth,</a>


</div>

</article>

	<!--<div class="share">-->
	<!--<div class="addthis_toolbox addthis_default_style ">-->
	<!---->
	<!--<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>-->
	<!---->
	<!---->
	<!--<a class="addthis_button_tweet"></a>-->
	<!---->
	<!---->
	<!--<a class="addthis_counter addthis_pill_style"></a>-->
	<!--</div>-->
  <!--<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>-->
<!--</div>-->


</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2018 - Scott Williams -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
			



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





		</div>
	</div>
</body>
</html>
